---
import Dashboard from "../../../layouts/Dashboard.astro";
import { db } from "../../../lib/db";
import { projects, conversions, questions } from "../../../lib/db/schema";
import { desc, eq, isNull, isNotNull, count, and } from "drizzle-orm";

const projectId = Number(Astro.params.id);
if (isNaN(projectId)) return Astro.redirect("/");

const [project] = await db.select().from(projects).where(eq(projects.id, projectId));
if (!project) return Astro.redirect("/");

const recentConversions = await db
  .select()
  .from(conversions)
  .where(eq(conversions.projectId, projectId))
  .orderBy(desc(conversions.startedAt))
  .limit(10);

const pendingQuestionsList = await db
  .select({
    id: questions.id,
    componentPath: questions.componentPath,
    questionText: questions.questionText,
    context: questions.context,
    createdAt: questions.createdAt,
  })
  .from(questions)
  .innerJoin(conversions, eq(questions.conversionId, conversions.id))
  .where(and(eq(conversions.projectId, projectId), isNull(questions.answeredAt)))
  .orderBy(desc(questions.createdAt));

const runningConversion = recentConversions.find((c) =>
  ["pending", "analyzing", "converting", "pushing", "deploying"].includes(c.status),
);
const waitingConversion = recentConversions.find((c) => c.status === "waiting_answers");
const lastConversion = recentConversions[0];

function statusLabel(status: string) {
  const map: Record<string, string> = {
    pending: "En file d'attente",
    analyzing: "Analyse en cours...",
    converting: "Conversion en cours...",
    pushing: "Publication du code...",
    deploying: "Déploiement preview...",
    done: "Terminé",
    error: "Erreur",
    waiting_answers: "En attente de vos réponses",
  };
  return map[status] ?? status;
}
---

<Dashboard title="Dashboard" projectId={projectId} projectName={project.name}>
  <div class="space-y-8">
    <!-- En-tête + bouton conversion -->
    <div class="flex justify-between items-start">
      <div>
        <h1 class="text-2xl font-bold text-foreground">{project.name}</h1>
        <p class="mt-1 text-sm text-muted-foreground">{project.sourceRepo}</p>
      </div>
      <button
        id="convert-btn"
        data-project-id={projectId}
        class="px-5 py-2.5 bg-primary text-primary-foreground text-sm font-medium rounded-lg hover:bg-primary/90 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
        disabled={!!runningConversion}
      >
        {runningConversion ? "Conversion en cours..." : "Lancer la conversion"}
      </button>
    </div>

    <!-- Bannière de statut si conversion en cours -->
    {runningConversion && (
      <div class="rounded-lg border border-blue-200 bg-blue-50 p-4 flex items-center gap-3">
        <div class="animate-spin rounded-full h-5 w-5 border-2 border-blue-600 border-t-transparent"></div>
        <div>
          <p class="text-sm font-medium text-blue-900">{statusLabel(runningConversion.status)}</p>
          <p class="text-xs text-blue-700 mt-0.5">L'outil analyse et convertit votre projet Lovable en Astro.</p>
        </div>
      </div>
    )}

    <!-- Bannière questions en attente -->
    {pendingQuestionsList.length > 0 && (
      <div class="rounded-lg border border-orange-200 bg-orange-50 p-4">
        <div class="flex items-center gap-2 mb-3">
          <svg xmlns="http://www.w3.org/2000/svg" class="size-5 text-orange-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
          <h2 class="text-sm font-semibold text-orange-900">
            {pendingQuestionsList.length} question{pendingQuestionsList.length > 1 ? "s" : ""} — L'outil a besoin de votre avis
          </h2>
        </div>
        <p class="text-xs text-orange-700 mb-4">
          Certains composants React peuvent être rendus de manière statique (HTML pur, plus rapide) ou en tant qu'îlot interactif (React côté client). Indiquez votre choix pour chaque composant.
        </p>
        <div class="space-y-3">
          {pendingQuestionsList.map((q) => (
            <div class="bg-white rounded-md border border-orange-100 p-4">
              <div class="flex justify-between items-start mb-2">
                <code class="text-sm font-mono text-foreground font-medium">{q.componentPath}</code>
              </div>
              <p class="text-sm text-muted-foreground mb-3">{q.questionText}</p>
              <form method="POST" action={`/api/queue/${q.id}/answer`} class="flex flex-wrap gap-2">
                <button
                  type="submit"
                  name="answer"
                  value="static"
                  class="px-3 py-1.5 text-sm bg-secondary hover:bg-secondary/80 rounded-md font-medium transition-colors"
                >
                  Statique (HTML pur)
                </button>
                <button
                  type="submit"
                  name="answer"
                  value="island:client:load"
                  class="px-3 py-1.5 text-sm bg-blue-100 hover:bg-blue-200 text-blue-800 rounded-md font-medium transition-colors"
                >
                  Interactif (chargement immédiat)
                </button>
                <button
                  type="submit"
                  name="answer"
                  value="island:client:visible"
                  class="px-3 py-1.5 text-sm bg-blue-50 hover:bg-blue-100 text-blue-700 rounded-md font-medium transition-colors"
                >
                  Interactif (au scroll)
                </button>
              </form>
            </div>
          ))}
        </div>
      </div>
    )}

    <!-- Dernière conversion réussie / erreur -->
    {lastConversion && !runningConversion && (
      <div class:list={[
        "rounded-lg border p-4",
        lastConversion.status === "done" && "border-green-200 bg-green-50",
        lastConversion.status === "error" && "border-red-200 bg-red-50",
        lastConversion.status === "waiting_answers" && "border-orange-200 bg-orange-50",
        !["done", "error", "waiting_answers"].includes(lastConversion.status) && "border-border bg-card",
      ]}>
        <div class="flex justify-between items-center">
          <div>
            <p class:list={[
              "text-sm font-medium",
              lastConversion.status === "done" && "text-green-900",
              lastConversion.status === "error" && "text-red-900",
              lastConversion.status === "waiting_answers" && "text-orange-900",
              !["done", "error", "waiting_answers"].includes(lastConversion.status) && "text-foreground",
            ]}>
              Dernière conversion : {statusLabel(lastConversion.status)}
            </p>
            <p class="text-xs text-muted-foreground mt-0.5">
              {lastConversion.commitMessage} — {lastConversion.startedAt}
            </p>
          </div>
          <a
            href={`/project/${projectId}/conversion/${lastConversion.id}`}
            class="text-sm text-muted-foreground hover:text-foreground transition-colors"
          >
            Voir le détail →
          </a>
        </div>
        {lastConversion.errorMessage && (
          <pre class="mt-3 text-xs text-red-800 bg-red-100 p-3 rounded overflow-x-auto">{lastConversion.errorMessage}</pre>
        )}
      </div>
    )}

    <!-- Historique conversions -->
    {recentConversions.length > 1 && (
      <div class="rounded-lg border border-border bg-card">
        <div class="px-6 py-4 border-b border-border">
          <h2 class="text-sm font-medium text-muted-foreground uppercase tracking-wide">Historique</h2>
        </div>
        <div class="divide-y divide-border">
          {recentConversions.slice(1).map((c) => (
            <a href={`/project/${projectId}/conversion/${c.id}`} class="flex items-center justify-between px-6 py-3 hover:bg-muted/50 transition-colors">
              <div class="flex items-center gap-3">
                <span class:list={[
                  "w-2 h-2 rounded-full shrink-0",
                  c.status === "done" && "bg-green-500",
                  c.status === "error" && "bg-red-500",
                  c.status === "waiting_answers" && "bg-orange-500",
                  !["done", "error", "waiting_answers"].includes(c.status) && "bg-blue-500",
                ]} />
                <span class="text-sm text-card-foreground">{c.commitMessage || c.commitSha.slice(0, 7)}</span>
              </div>
              <span class="text-xs text-muted-foreground">{c.startedAt}</span>
            </a>
          ))}
        </div>
      </div>
    )}

    <!-- État vide -->
    {recentConversions.length === 0 && pendingQuestionsList.length === 0 && (
      <div class="text-center py-16">
        <div class="rounded-full bg-muted p-4 inline-block mb-4">
          <svg xmlns="http://www.w3.org/2000/svg" class="size-8 text-muted-foreground" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
            <path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0l3.181 3.183a8.25 8.25 0 0013.803-3.7M4.031 9.865a8.25 8.25 0 0113.803-3.7l3.181 3.182M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
          </svg>
        </div>
        <h2 class="text-lg font-semibold text-foreground">Prêt à convertir</h2>
        <p class="mt-1 text-sm text-muted-foreground max-w-md mx-auto">
          Cliquez sur "Lancer la conversion" pour analyser votre projet Lovable et le convertir en Astro avec des îlots React.
        </p>
      </div>
    )}
  </div>

  <script>
    const convertBtn = document.getElementById("convert-btn") as HTMLButtonElement | null;
    if (convertBtn) {
      const projectId = convertBtn.dataset.projectId;
      convertBtn.addEventListener("click", async () => {
        convertBtn.disabled = true;
        convertBtn.textContent = "Lancement...";
        try {
          const res = await fetch("/api/conversions/trigger", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ projectId: Number(projectId) }),
          });
          const data = await res.json();
          if (data.conversionId) {
            window.location.reload();
          } else {
            alert("Erreur : " + (data.error ?? "inconnue"));
            convertBtn.disabled = false;
            convertBtn.textContent = "Lancer la conversion";
          }
        } catch {
          alert("Erreur réseau");
          convertBtn.disabled = false;
          convertBtn.textContent = "Lancer la conversion";
        }
      });
    }

    // Auto-refresh si une conversion est en cours
    const hasRunning = document.querySelector('.animate-spin');
    if (hasRunning) {
      setTimeout(() => window.location.reload(), 5000);
    }
  </script>
</Dashboard>
