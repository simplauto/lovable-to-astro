---
import Dashboard from "../../../layouts/Dashboard.astro";
import { db } from "../../../lib/db";
import { projects } from "../../../lib/db/schema";
import { eq } from "drizzle-orm";

const projectId = Number(Astro.params.id);
if (isNaN(projectId)) return Astro.redirect("/");

const [project] = await db.select().from(projects).where(eq(projects.id, projectId));
if (!project) return Astro.redirect("/");
---

<Dashboard title="Fichiers" projectId={projectId} projectName={project.name}>
  <div class="flex gap-6 h-[calc(100vh-12rem)]">
    <!-- Arbre des fichiers -->
    <div id="file-tree" class="w-72 shrink-0 border border-border rounded-lg bg-card overflow-y-auto">
      <div class="px-4 py-3 border-b border-border">
        <h2 class="text-sm font-medium text-muted-foreground uppercase tracking-wide">Fichiers gÃ©nÃ©rÃ©s</h2>
      </div>
      <div id="tree-content" class="p-2">
        <div class="flex items-center justify-center py-8">
          <div class="animate-spin rounded-full h-5 w-5 border-2 border-primary border-t-transparent"></div>
        </div>
      </div>
    </div>

    <!-- Contenu du fichier -->
    <div class="flex-1 border border-border rounded-lg bg-card overflow-hidden flex flex-col">
      <div id="file-header" class="px-4 py-3 border-b border-border flex items-center justify-between">
        <span id="file-path" class="text-sm font-mono text-muted-foreground">SÃ©lectionnez un fichier</span>
        <button
          id="copy-btn"
          class="hidden px-3 py-1 text-xs bg-secondary hover:bg-secondary/80 rounded-md font-medium transition-colors"
        >
          Copier
        </button>
      </div>
      <div id="file-content" class="flex-1 overflow-auto">
        <div id="empty-state" class="flex items-center justify-center h-full text-sm text-muted-foreground">
          <div class="text-center">
            <svg xmlns="http://www.w3.org/2000/svg" class="size-12 mx-auto mb-3 text-muted-foreground/50" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1">
              <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m0 12.75h7.5m-7.5 3H12M10.5 2.25H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z" />
            </svg>
            <p>Cliquez sur un fichier pour voir son contenu</p>
          </div>
        </div>
        <pre id="code-display" class="hidden p-4 text-sm font-mono leading-relaxed whitespace-pre-wrap break-words"></pre>
      </div>
    </div>
  </div>

  <script define:vars={{ projectId }}>
    const treeContent = document.getElementById("tree-content");
    const filePathEl = document.getElementById("file-path");
    const codeDisplay = document.getElementById("code-display");
    const emptyState = document.getElementById("empty-state");
    const copyBtn = document.getElementById("copy-btn");

    // IcÃ´nes par extension
    function fileIcon(name) {
      const ext = name.split(".").pop();
      const icons = {
        astro: "ğŸŸ£",
        tsx: "âš›ï¸",
        jsx: "âš›ï¸",
        ts: "ğŸ”·",
        js: "ğŸŸ¡",
        json: "ğŸ“‹",
        css: "ğŸ¨",
        md: "ğŸ“",
        svg: "ğŸ–¼ï¸",
        mjs: "ğŸŸ¡",
      };
      return icons[ext] || "ğŸ“„";
    }

    function renderTree(entries, container, depth = 0) {
      for (const entry of entries) {
        const el = document.createElement("div");

        if (entry.type === "directory") {
          el.innerHTML = `
            <button class="w-full text-left px-2 py-1 rounded hover:bg-accent/50 flex items-center gap-1.5 text-sm transition-colors" style="padding-left: ${depth * 16 + 8}px" data-collapsed="false">
              <span class="folder-icon text-xs">â–¼</span>
              <span>ğŸ“</span>
              <span class="text-card-foreground">${entry.name}</span>
            </button>
            <div class="children"></div>
          `;

          const btn = el.querySelector("button");
          const children = el.querySelector(".children");
          const icon = el.querySelector(".folder-icon");

          btn.addEventListener("click", () => {
            const collapsed = btn.dataset.collapsed === "true";
            btn.dataset.collapsed = collapsed ? "false" : "true";
            children.style.display = collapsed ? "block" : "none";
            icon.textContent = collapsed ? "â–¼" : "â–¶";
          });

          if (entry.children) {
            renderTree(entry.children, children, depth + 1);
          }
        } else {
          el.innerHTML = `
            <button class="file-btn w-full text-left px-2 py-1 rounded hover:bg-accent/50 flex items-center gap-1.5 text-sm transition-colors" style="padding-left: ${depth * 16 + 8}px" data-path="${entry.path}">
              <span>${fileIcon(entry.name)}</span>
              <span class="text-card-foreground truncate">${entry.name}</span>
              ${entry.size !== undefined ? `<span class="text-xs text-muted-foreground ml-auto shrink-0">${formatSize(entry.size)}</span>` : ""}
            </button>
          `;

          el.querySelector(".file-btn").addEventListener("click", () => loadFile(entry.path));
        }

        container.appendChild(el);
      }
    }

    function formatSize(bytes) {
      if (bytes < 1024) return `${bytes} B`;
      if (bytes < 1024 * 1024) return `${(bytes / 1024).toFixed(1)} KB`;
      return `${(bytes / (1024 * 1024)).toFixed(1)} MB`;
    }

    async function loadFile(path) {
      // Highlight selected file
      document.querySelectorAll(".file-btn").forEach((btn) => {
        btn.classList.remove("bg-accent", "text-accent-foreground");
      });
      const selectedBtn = document.querySelector(`.file-btn[data-path="${CSS.escape(path)}"]`);
      if (selectedBtn) {
        selectedBtn.classList.add("bg-accent", "text-accent-foreground");
      }

      filePathEl.textContent = path;
      codeDisplay.textContent = "Chargement...";
      codeDisplay.classList.remove("hidden");
      emptyState.classList.add("hidden");
      copyBtn.classList.remove("hidden");

      try {
        const res = await fetch(`/api/projects/${projectId}/files/${path}`);
        if (!res.ok) throw new Error("Fichier introuvable");
        const data = await res.json();
        codeDisplay.textContent = data.content;

        // Coloration syntaxique basique par lignes numÃ©rotÃ©es
        const lines = data.content.split("\n");
        codeDisplay.innerHTML = lines
          .map((line, i) => {
            const num = String(i + 1).padStart(4, " ");
            const escaped = line
              .replace(/&/g, "&amp;")
              .replace(/</g, "&lt;")
              .replace(/>/g, "&gt;");
            return `<span class="text-muted-foreground/50 select-none">${num}</span>  ${escaped}`;
          })
          .join("\n");
      } catch (err) {
        codeDisplay.textContent = "Erreur : " + err.message;
      }
    }

    // Copier le contenu
    copyBtn?.addEventListener("click", () => {
      const text = codeDisplay?.textContent || "";
      navigator.clipboard.writeText(text).then(() => {
        copyBtn.textContent = "CopiÃ© !";
        setTimeout(() => { copyBtn.textContent = "Copier"; }, 2000);
      });
    });

    // Charger l'arbre
    fetch(`/api/projects/${projectId}/files`)
      .then((r) => r.json())
      .then((tree) => {
        treeContent.innerHTML = "";
        if (tree.length === 0) {
          treeContent.innerHTML = `
            <div class="text-center py-8 text-sm text-muted-foreground">
              <p>Aucun fichier gÃ©nÃ©rÃ©.</p>
              <p class="mt-1 text-xs">Lancez une conversion depuis le Dashboard.</p>
            </div>
          `;
        } else {
          renderTree(tree, treeContent);
        }
      })
      .catch(() => {
        treeContent.innerHTML = `<p class="text-sm text-destructive p-4">Erreur de chargement</p>`;
      });
  </script>
</Dashboard>
