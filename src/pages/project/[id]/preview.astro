---
import Dashboard from "../../../layouts/Dashboard.astro";
import { db } from "../../../lib/db";
import { projects, conversions } from "../../../lib/db/schema";
import { eq, desc } from "drizzle-orm";

const projectId = Number(Astro.params.id);
if (isNaN(projectId)) return Astro.redirect("/");

const [project] = await db.select().from(projects).where(eq(projects.id, projectId));
if (!project) return Astro.redirect("/");

const [lastDone] = await db
  .select()
  .from(conversions)
  .where(eq(conversions.projectId, projectId))
  .orderBy(desc(conversions.startedAt))
  .limit(1);

const hasConversion = lastDone?.status === "done";
const previewUrl = `/api/projects/${projectId}/preview/`;
---

<Dashboard title="Preview" projectId={projectId} projectName={project.name}>
  {hasConversion ? (
    <div class="space-y-4">
      <div class="flex items-center justify-between">
        <div>
          <h1 class="text-xl font-bold text-foreground">Preview du site Astro</h1>
          <p class="text-sm text-muted-foreground mt-0.5">
            Rendu statique de la dernière conversion réussie
          </p>
        </div>
        <div class="flex items-center gap-2">
          <select id="viewport-select" class="px-3 py-1.5 text-sm border border-border rounded-md bg-card">
            <option value="100%">Desktop</option>
            <option value="768px">Tablette</option>
            <option value="375px">Mobile</option>
          </select>
          <a
            href={previewUrl}
            target="_blank"
            class="px-3 py-1.5 text-sm bg-secondary hover:bg-secondary/80 rounded-md font-medium transition-colors"
          >
            Ouvrir dans un nouvel onglet
          </a>
        </div>
      </div>

      <div class="border border-border rounded-lg bg-white overflow-hidden" style="height: calc(100vh - 14rem);">
        <iframe
          id="preview-frame"
          src={previewUrl}
          class="w-full h-full mx-auto transition-all duration-300"
          style="border: none;"
        ></iframe>
      </div>
    </div>
  ) : (
    <div class="text-center py-16">
      <div class="rounded-full bg-muted p-4 inline-block mb-4">
        <svg xmlns="http://www.w3.org/2000/svg" class="size-8 text-muted-foreground" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
          <path stroke-linecap="round" stroke-linejoin="round" d="M2.036 12.322a1.012 1.012 0 010-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.431 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573-3.007-9.963-7.178z" />
          <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
        </svg>
      </div>
      <h2 class="text-lg font-semibold text-foreground">Aucune preview disponible</h2>
      <p class="mt-1 text-sm text-muted-foreground max-w-md mx-auto">
        Lancez une conversion depuis le Dashboard pour voir la preview du site Astro.
      </p>
      <a
        href={`/project/${projectId}`}
        class="inline-block mt-4 px-5 py-2.5 bg-primary text-primary-foreground text-sm font-medium rounded-lg hover:bg-primary/90 transition-colors"
      >
        Aller au Dashboard
      </a>
    </div>
  )}

  <script>
    const select = document.getElementById("viewport-select") as HTMLSelectElement | null;
    const iframe = document.getElementById("preview-frame") as HTMLIFrameElement | null;

    if (select && iframe) {
      select.addEventListener("change", () => {
        const width = select.value;
        iframe.style.maxWidth = width;
        iframe.style.margin = width === "100%" ? "0" : "0 auto";
      });
    }
  </script>
</Dashboard>
