---
import Dashboard from "../../../../layouts/Dashboard.astro";
import { db } from "../../../../lib/db";
import { projects, conversions, questions } from "../../../../lib/db/schema";
import { eq, and } from "drizzle-orm";

const projectId = Number(Astro.params.id);
const conversionId = Number(Astro.params.cid);
if (isNaN(projectId) || isNaN(conversionId)) return Astro.redirect("/");

const [project] = await db.select().from(projects).where(eq(projects.id, projectId));
if (!project) return Astro.redirect("/");

const [conversion] = await db
  .select()
  .from(conversions)
  .where(and(eq(conversions.id, conversionId), eq(conversions.projectId, projectId)));

if (!conversion) return Astro.redirect(`/project/${projectId}`);

const relatedQuestions = await db
  .select()
  .from(questions)
  .where(eq(questions.conversionId, conversionId));

const statusColors: Record<string, string> = {
  pending: "bg-secondary text-secondary-foreground",
  analyzing: "bg-blue-100 text-blue-800",
  converting: "bg-blue-100 text-blue-800",
  pushing: "bg-blue-100 text-blue-800",
  deploying: "bg-blue-100 text-blue-800",
  done: "bg-green-100 text-green-800",
  error: "bg-red-100 text-red-800",
  waiting_answers: "bg-orange-100 text-orange-800",
};
---

<Dashboard title={`Conversion ${conversion.commitSha.slice(0, 7)}`} projectId={projectId} projectName={project.name}>
  <div class="space-y-6">
    <div class="flex items-center gap-4">
      <a href={`/project/${projectId}`} class="text-sm text-muted-foreground hover:text-foreground">&larr; Retour</a>
      <h1 class="text-2xl font-bold text-foreground">
        Conversion <code class="font-mono">{conversion.commitSha.slice(0, 7)}</code>
      </h1>
      <span class={`px-2 py-1 text-xs rounded-full font-medium ${statusColors[conversion.status] ?? "bg-secondary text-secondary-foreground"}`}>
        {conversion.status}
      </span>
    </div>

    <div class="rounded-lg border border-border bg-card p-6">
      <dl class="grid grid-cols-2 gap-x-8 gap-y-4">
        <div>
          <dt class="text-sm font-medium text-muted-foreground">Commit SHA</dt>
          <dd class="mt-1 text-sm font-mono text-card-foreground">{conversion.commitSha}</dd>
        </div>
        <div>
          <dt class="text-sm font-medium text-muted-foreground">Branche</dt>
          <dd class="mt-1 text-sm text-card-foreground">{conversion.branch}</dd>
        </div>
        <div>
          <dt class="text-sm font-medium text-muted-foreground">Message</dt>
          <dd class="mt-1 text-sm text-card-foreground">{conversion.commitMessage ?? "—"}</dd>
        </div>
        <div>
          <dt class="text-sm font-medium text-muted-foreground">Démarré le</dt>
          <dd class="mt-1 text-sm text-card-foreground">{conversion.startedAt}</dd>
        </div>
        {conversion.finishedAt && (
          <div>
            <dt class="text-sm font-medium text-muted-foreground">Terminé le</dt>
            <dd class="mt-1 text-sm text-card-foreground">{conversion.finishedAt}</dd>
          </div>
        )}
        {conversion.errorMessage && (
          <div class="col-span-2">
            <dt class="text-sm font-medium text-destructive">Erreur</dt>
            <dd class="mt-1 text-sm text-red-800 bg-red-50 p-3 rounded font-mono whitespace-pre-wrap">
              {conversion.errorMessage}
            </dd>
          </div>
        )}
      </dl>
    </div>

    {relatedQuestions.length > 0 && (
      <div class="rounded-lg border border-border bg-card">
        <div class="px-6 py-4 border-b border-border">
          <h2 class="text-lg font-medium text-card-foreground">
            Questions ({relatedQuestions.length})
          </h2>
        </div>
        <div class="divide-y divide-border">
          {relatedQuestions.map((q) => (
            <div class="px-6 py-4 space-y-1">
              <div class="flex justify-between items-center">
                <span class="font-mono text-sm text-card-foreground">{q.componentPath}</span>
                {q.answer ? (
                  <span class="px-2 py-1 text-xs rounded-full bg-green-100 text-green-800 font-medium">
                    {q.answer}
                  </span>
                ) : (
                  <span class="px-2 py-1 text-xs rounded-full bg-orange-100 text-orange-800 font-medium">
                    En attente
                  </span>
                )}
              </div>
              <p class="text-sm text-muted-foreground">{q.questionText}</p>
            </div>
          ))}
        </div>
      </div>
    )}
  </div>
</Dashboard>
